




2.3.系统总体架构

<img src="系统架构图"/>
<img src="功能架构图"/>
<img src="部署图"/>

系统采用分层架构，总体上分为四层，由上到下分别是用户层，接口层，业务层和数据持久层。
用户层负责接收用户请求和向用户展示内容。
接口层负责客户端和服务器的通信。
服务层负责业务处理。
数据存储层负责数据的持久化存储。

在服务层存在逻辑上的三台服务器，分别是应用服务器，聊天服务器和媒体资源服务器。
应用服务器负责管理用户和群组信息。
聊天服务器负责实现用户的及时聊天。
媒体资源服务器实现图片和表情的快速存取。


2.3.1.用户层

用户层负责接收用户请求和向用户展示内容，部署在客户端上。
用户层还要处理与服务器的通信，以向服务器发送请求和获得响应。

2.3.2.接口层

接口层在服务器端，负责和客户端通信，也是服务器端消息的入口。
根据IM应用的特点，通信主要分为两种方式：短轮询和长连接。
短轮询是指客户端以一定的时间间隔询问服务器是否有新消息出现。
长连接是指客户端和服务器维护一条TCP连接，当有新消息出现时，服务器主动通知客户端。
当用户当前回话稀疏时，采用短轮询方式，当会话密集时，采用长连接方式。

2.3.3.应用服务器

应用服务器负责处理用户注册及登录，用户好友关系的建立与删除，群组关系的建立和删除等业务，并将信息写入数据持久层以及通知聊天服务器执行相应的变更。

2.3.4.聊天服务器

聊天服务器负责用户和群组的即时聊天功能，同时需要满足高吞吐量和低延迟等要求。
系统为每个用户维护一个消息队列，当其他用户向该用户发送消息时，就将消息放入该用户的消息队列。每个用户的消息队列之间是独立的。系统同时根据聊天状况切换与用户的连接方式，当消息稀疏时采用短轮询，当消息密集时采用长连接。
系统为每个群组维护一个消息队列。当用户在群中发送消息时，将消息插入队尾，并同时由该消息队列负责分发消息至用户的消息队列中。

2.3.5.媒体资源服务器

媒体资源服务器负责图片和表情的快速存储和取用，同时需要满足高吞吐量的要求。
将媒体资源独立出来有利于实现主干消息的低延迟响应。

2.4.6.数据持久层

数据存储层使用数据库来实现数据的持久化存储。
需要持久化存储的数据包括用户信息，用户好友关系，群组信息，用户消息记录，群组消息记录以及媒体资源等等。

